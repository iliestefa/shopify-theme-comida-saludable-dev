{%- assign days_product_price_valid_until = 10 | times: 86400 -%}
{%- assign is_valid_global_gtin_length = false -%}
{%- if product.selected_or_first_available_variant.barcode != blank -%}
  {%- assign gtin_string_length = product.selected_or_first_available_variant.barcode | size -%}

  {%- if gtin_string_length == 8 or gtin_string_length == 12 or gtin_string_length == 13 or gtin_string_length == 14 -%}
    {%- assign is_valid_global_gtin_length = true -%}
  {%- endif -%}
{%- endif -%}

<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "productID": {{ product.id | json }},
    "name": {{ product.title | json }},
    "description": {{ product.description | strip_html | json }},
    "category": {{ product.type | json }},
    "url": "{{ shop.url }}{{ product.url }}",
    "sku": {{ product.selected_or_first_available_variant.sku | json }},
    "brand": {
      "@type": "Brand",
      "name": {{ product.vendor | json }}
    },
    "offers": [
      {%- for variant in product.variants -%}
        {%- assign is_valid_gtin_length = false -%}

        {%- if variant.barcode != blank -%}
          {%- assign gtin_string_length = variant.barcode | size -%}

          {%- if gtin_string_length == 8 or gtin_string_length == 12 or gtin_string_length == 13 or gtin_string_length == 14 -%}
            {%- assign is_valid_gtin_length = true -%}
          {%- endif -%}
        {%- endif -%}
        {
          "@type": "Offer",
          "name": {% if product.has_only_default_variant %}{{ product.title | json }}{% else %}{{ variant.title | json }}{% endif %},
          "availability": {%- if variant.available -%}"https://schema.org/InStock"{%- elsif variant.incoming -%}"https://schema.org/BackOrder"{% else %}"https://schema.org/OutOfStock"{%- endif -%},
          "price": {{ variant.price | divided_by: 100.0 | json }},
          "priceCurrency": {{ cart.currency.iso_code | json }},
          "priceValidUntil": "{{ 'now' | date: '%s' | plus: days_product_price_valid_until | date: '%Y-%m-%d' }}",
          "hasMerchantReturnPolicy": {
            "merchantReturnLink": {{ shop.refund_policy.url | prepend: request.origin | json }}
          },
          "shippingDetails": {
            "shippingSettingsLink": {{ shop.shipping_policy.url | prepend: request.origin | json }}
          },
          {%- if variant.sku != blank -%}
            "sku": {{ variant.sku | json }},
          {%- endif -%}
          {%- if variant.barcode != blank -%}
            {%- if is_valid_gtin_length -%}
              "gtin": {{ variant.barcode | json }},
            {%- else -%}
              "mpn": {{ variant.barcode | json }},
            {%- endif -%}
          {%- endif -%}
          "url": "{{ shop.url }}{{ product.url }}?variant={{ variant.id }}"
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],
    {%- assign review_count = product.metafields.yotpo.reviews_count.value | default: 0 | plus: 0 -%}
    {%- assign review_average = product.metafields.yotpo.reviews_average.value | default: 0.0 | plus: 0.0 -%}
    {%- if review_average > 0 and review_count > 0 -%}
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": {{ review_average | json }},
        "reviewCount": {{ review_count | json }}
      },
    {%- endif -%}
    {%- if product.selected_or_first_available_variant.barcode != blank -%}
      {%- if is_valid_global_gtin_length -%}
        "gtin": {{ product.selected_or_first_available_variant.barcode | json }},
      {%- else -%}
        "mpn": {{ product.selected_or_first_available_variant.barcode | json }},
      {%- endif -%}
    {%- endif -%}
    {%- if product.selected_or_first_available_variant.weight -%}
    "weight": {
      "@type": "QuantitativeValue",
      "unitCode": {{ product.selected_or_first_available_variant.weight_unit | json }},
      "value": {{ product.selected_or_first_available_variant.weight_in_unit | json }}
    },
    {%- endif -%}
    "image": {
      "@type": "ImageObject",
      "url": "https:{{ page_image | image_url: width: 1024 }}",
      "image": "https:{{ page_image | image_url: width: 1024 }}",
      "name": {{ page_image.alt | json }},
      "width": "1024",
      "height": "1024"
    }
  }
</script>
